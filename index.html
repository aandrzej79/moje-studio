<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SATB Studio Pro - WebM Mix Edition</title>
    <style>
        :root {
            --bg: #0b0e11;
            --panel: #1a1f24;
            --accent: #f1c40f;
            --vocal: #e74c3c;
            --instr: #3498db;
            --text: #ffffff;
            --success: #2ecc71;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
            overscroll-behavior-y: contain;
        }

        .container { max-width: 850px; margin: auto; }

        .project-panel {
            background: var(--panel);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 10px;
            border-bottom: 4px solid var(--accent);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .project-panel label { font-size: 0.75rem; color: var(--accent); font-weight: bold; text-transform: uppercase; }
        .project-panel input { background: rgba(0,0,0,0.3); border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; font-size: 1.1rem; outline: none; }

        #exportBtn {
            width: 100%;
            background: var(--success);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        #exportBtn:disabled { background: #444; cursor: not-allowed; box-shadow: none; }

        .header-panel {
            background: var(--panel);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @media (min-width: 600px) { .header-panel { flex-direction: row; align-items: center; } }

        .metro-controls { flex-grow: 1; width: 100%; }
        .control-group { margin-bottom: 12px; }
        .info-row { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        input[type="range"] { width: 100%; height: 25px; accent-color: var(--accent); cursor: pointer; }

        #metroBtn { background: var(--accent); color: black; border: none; padding: 20px; border-radius: 12px; font-weight: bold; font-size: 1.1rem; min-width: 140px; cursor: pointer; }

        .flash-circle { width: 15px; height: 15px; background: #333; border-radius: 50%; margin: 10px auto 0; transition: 0.05s; }
        .flash-circle.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); }

        h3 { font-size: 0.8rem; color: #888; text-transform: uppercase; margin: 25px 0 10px 5px; border-left: 3px solid #444; padding-left: 10px; }
        
        .track { background: var(--panel); padding: 12px 15px; border-radius: 12px; margin-bottom: 8px; border-left: 6px solid #444; display: grid; grid-template-columns: 1fr; gap: 12px; align-items: center; }
        @media (min-width: 650px) { .track { grid-template-columns: 160px 140px 1fr; gap: 20px; } }

        .vocal { border-left-color: var(--vocal); }
        .instr { border-left-color: var(--instr); }
        .track-name { font-weight: bold; font-size: 0.9rem; }

        .monitor-box { font-size: 0.85rem; display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 8px; justify-self: start; min-width: 110px; }
        .btns { display: flex; gap: 8px; width: 100%; }
        button.rec { background: var(--vocal); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; flex: 2; cursor: pointer; }
        button.rec.active { background: #fff; color: var(--vocal); animation: pulse 1s infinite; }
        .dl-btn { background: var(--success); color: white; text-decoration: none; padding: 10px; border-radius: 8px; font-weight: bold; display: none; flex: 1; text-align: center; font-size: 0.75rem; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="project-panel">
        <label for="projectName">Nazwa Projektu</label>
        <input type="text" id="projectName" value="Dubra">
    </div>

    <button id="exportBtn" onclick="exportMixedAudio()">
        üíæ EKSPORTUJ ZAZNACZONE (MIX .WEBM)
    </button>

    <div class="header-panel">
        <div class="metro-controls">
            <div class="control-group">
                <div class="info-row"><span>TEMPO:</span><span style="color:var(--accent)"><span id="bpmVal">60</span> BPM</span></div>
                <input type="range" id="bpmSlider" min="40" max="180" value="60">
            </div>
            <div class="control-group">
                <div class="info-row"><span>G≈ÅO≈öNO≈öƒÜ KLIKU:</span><span id="volVal">50%</span></div>
                <input type="range" id="volSlider" min="0" max="100" value="50">
            </div>
        </div>
        <div style="text-align:center">
            <button id="metroBtn">START</button>
            <div id="visual" class="flash-circle"></div>
        </div>
    </div>

    <div id="vocal-list"></div>
    <div id="instr-list"></div>
</div>

<script>
    const vocalVoices = [
        {id:'v_sop', name:'Sopran', label:'WOKAL SOPRAN'}, {id:'v_alt', name:'Alt', label:'WOKAL ALT'},
        {id:'v_ten', name:'Tenor', label:'WOKAL TENOR'}, {id:'v_bas', name:'Bas', label:'WOKAL BAS'}
    ];
    const instrVoices = [
        {id:'i_sop', name:'Instr_Sopran', label:'INSTR. SOPRAN'}, {id:'i_alt', name:'Instr_Alt', label:'INSTR. ALT'},
        {id:'i_ten', name:'Instr_Tenor', label:'INSTR. TENOR'}, {id:'i_bas', name:'Instr_Bas', label:'INSTR. BAS'}
    ];

    let audioCtx = null;
    let metroTimer = null;
    let recorders = {};
    let chunks = {};
    let audioBlobs = {}; 

    async function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
    }

    document.body.addEventListener('touchstart', initAudio, { once: true });
    document.body.addEventListener('click', initAudio, { once: true });

    function render() {
        const vL = document.getElementById('vocal-list');
        const iL = document.getElementById('instr-list');
        vL.innerHTML = "<h3>üé§ G≈Çosy Wokalne</h3>";
        iL.innerHTML = "<h3>üéπ Instrumenty</h3>";
        [...vocalVoices].forEach(v => vL.innerHTML += createTrackHTML(v, 'vocal'));
        [...instrVoices].forEach(v => iL.innerHTML += createTrackHTML(v, 'instr'));
    }

    function createTrackHTML(v, type) {
        return `<div class="track ${type}">
            <div class="track-name">${v.label}</div>
            <div class="monitor-box">
                <input type="checkbox" id="mon-${v.id}"> <label for="mon-${v.id}">S≈Çuchaj</label>
            </div>
            <div class="btns">
                <button id="btn-${v.id}" class="rec" onclick="handleRec('${v.id}', '${v.name}')">NAGRAJ</button>
                <a id="dl-${v.id}" class="dl-btn">POBIERZ</a>
            </div>
        </div>`;
    }

    const bpmS = document.getElementById('bpmSlider');
    const volS = document.getElementById('volSlider');
    bpmS.oninput = () => { document.getElementById('bpmVal').innerText = bpmS.value; if(metroTimer) { stopMetro(); startMetro(); } };
    volS.oninput = () => { document.getElementById('volVal').innerText = volS.value + "%"; };

    document.getElementById('metroBtn').onclick = async () => {
        await initAudio();
        if(metroTimer) { stopMetro(); document.getElementById('metroBtn').innerText="START"; }
        else { startMetro(); document.getElementById('metroBtn').innerText="STOP"; }
    };

    function startMetro() {
        const ms = 60000 / bpmS.value;
        metroTimer = setInterval(() => {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            osc.frequency.value = 1000;
            g.gain.setValueAtTime((volS.value/100)*0.4, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
            osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            const vis = document.getElementById('visual');
            vis.classList.add('active'); setTimeout(()=>vis.classList.remove('active'), 50);
        }, ms);
    }
    function stopMetro() { clearInterval(metroTimer); metroTimer = null; }

    async function handleRec(id, voiceName) {
        await initAudio();
        const btn = document.getElementById(`btn-${id}`);
        if (recorders[id] && recorders[id].state === "recording") {
            recorders[id].stop();
            btn.classList.remove('active'); btn.innerText = "NAGRAJ";
            return;
        }

        [...vocalVoices, ...instrVoices].forEach(v => {
            if (document.getElementById(`mon-${v.id}`).checked && audioBlobs[v.id]) {
                const au = new Audio(URL.createObjectURL(audioBlobs[v.id]));
                au.play();
            }
        });

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorders[id] = new MediaRecorder(stream);
            chunks[id] = [];
            recorders[id].ondataavailable = e => chunks[id].push(e.data);
            recorders[id].onstop = () => {
                audioBlobs[id] = new Blob(chunks[id], { type: 'audio/webm' });
                const url = URL.createObjectURL(audioBlobs[id]);
                const dl = document.getElementById(`dl-${id}`);
                dl.style.display = "flex"; dl.href = url;
                const projName = document.getElementById('projectName').value.replace(/\s+/g, '_') || 'Projekt';
                dl.download = `${projName}_${voiceName}.webm`;
            };
            recorders[id].start();
            btn.classList.add('active'); btn.innerText = "STOP";
        } catch(e) { alert("B≈ÇƒÖd mikrofonu!"); }
    }

    // --- EKSPORT MIXU DO WEBM ---
    async function exportMixedAudio() {
        await initAudio();
        const selectedIds = [...vocalVoices, ...instrVoices]
            .map(v => v.id)
            .filter(id => document.getElementById(`mon-${id}`).checked && audioBlobs[id]);

        if (selectedIds.length === 0) {
            alert("Zaznacz pole 'S≈Çuchaj' przy nagranych ≈õcie≈ºkach.");
            return;
        }

        const btn = document.getElementById('exportBtn');
        btn.innerText = "MIKSOWANIE...";
        btn.disabled = true;

        try {
            const buffers = await Promise.all(selectedIds.map(async id => {
                const arrayBuffer = await audioBlobs[id].arrayBuffer();
                return await audioCtx.decodeAudioData(arrayBuffer);
            }));

            const maxLen = Math.max(...buffers.map(b => b.length));
            const offlineCtx = new OfflineAudioContext(1, maxLen, audioCtx.sampleRate);

            buffers.forEach(buffer => {
                const source = offlineCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(offlineCtx.destination);
                source.start();
            });

            const renderedBuffer = await offlineCtx.startRendering();

            // Przechwytywanie do WebM
            const destination = audioCtx.createMediaStreamDestination();
            const source = audioCtx.createBufferSource();
            source.buffer = renderedBuffer;
            source.connect(destination);

            const recorder = new MediaRecorder(destination.stream, { mimeType: 'audio/webm' });
            const mixedChunks = [];
            recorder.ondataavailable = e => mixedChunks.push(e.data);
            recorder.onstop = () => {
                const finalBlob = new Blob(mixedChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(finalBlob);
                const projName = document.getElementById('projectName').value.replace(/\s+/g, '_') || 'Projekt';
                const link = document.createElement('a');
                link.href = url;
                link.download = `${projName}_MIX.webm`;
                link.click();
                btn.innerText = "üíæ EKSPORTUJ ZAZNACZONE (MIX .WEBM)";
                btn.disabled = false;
            };

            recorder.start();
            source.start();
            source.onended = () => recorder.stop();

        } catch (err) {
            console.error(err);
            alert("B≈ÇƒÖd podczas miksowania.");
            btn.disabled = false;
        }
    }

    render();
</script>
</body>
</html>
