<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SATB Studio Pro - Aligned Edition</title>
    <style>
        :root {
            --bg: #0b0e11;
            --panel: #1a1f24;
            --accent: #f1c40f;
            --vocal: #e74c3c;
            --instr: #3498db;
            --text: #ffffff;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
            overscroll-behavior-y: contain;
        }

        .container { max-width: 850px; margin: auto; }

        /* PANEL STEROWANIA */
        .header-panel {
            background: var(--panel);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--accent);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @media (min-width: 600px) {
            .header-panel { flex-direction: row; align-items: center; }
        }

        .metro-controls { flex-grow: 1; width: 100%; }
        .control-group { margin-bottom: 12px; }
        .info-row { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        
        input[type="range"] { width: 100%; height: 25px; accent-color: var(--accent); cursor: pointer; }

        #metroBtn {
            background: var(--accent);
            color: black;
            border: none;
            padding: 20px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            min-width: 140px;
            cursor: pointer;
        }

        .flash-circle {
            width: 15px; height: 15px; background: #333; border-radius: 50%; 
            margin: 10px auto 0; transition: 0.05s;
        }
        .flash-circle.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); }

        h3 { font-size: 0.8rem; color: #888; text-transform: uppercase; margin: 25px 0 10px 5px; border-left: 3px solid #444; padding-left: 10px; }
        
        /* UK≈ÅAD ≈öCIE≈ªEK - KLUCZ DO WYR√ìWNANIA */
        .track {
            background: var(--panel);
            padding: 12px 15px;
            border-radius: 12px;
            margin-bottom: 8px;
            border-left: 6px solid #444;
            display: grid;
            grid-template-columns: 1fr; /* Mobile: jeden pod drugim */
            gap: 12px;
            align-items: center;
        }

        /* Wyr√≥wnanie dla tablet√≥w i PC */
        @media (min-width: 650px) {
            .track {
                grid-template-columns: 160px 140px 1fr; /* Sta≈Çe szeroko≈õci dla nazwy i monitoringu */
                gap: 20px;
            }
        }

        .vocal { border-left-color: var(--vocal); }
        .instr { border-left-color: var(--instr); }

        .track-name { font-weight: bold; font-size: 0.9rem; white-space: nowrap; }

        .monitor-box {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.05);
            padding: 8px 12px;
            border-radius: 8px;
            justify-self: start; /* Trzyma siƒô lewej w swojej kolumnie */
            min-width: 110px;
        }

        .monitor-box input { width: 18px; height: 18px; cursor: pointer; }

        .btns { display: flex; gap: 8px; width: 100%; }

        button.rec {
            background: var(--vocal);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            flex: 2;
            cursor: pointer;
        }
        button.rec.active { background: #fff; color: var(--vocal); animation: pulse 1s infinite; }
        
        .dl-btn {
            background: #2ecc71;
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            display: none;
            flex: 1;
            text-align: center;
            font-size: 0.75rem;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-panel">
        <div class="metro-controls">
            <div class="control-group">
                <div class="info-row">
                    <span>TEMPO:</span>
                    <span style="color:var(--accent)"><span id="bpmVal">60</span> BPM</span>
                </div>
                <input type="range" id="bpmSlider" min="40" max="180" value="60">
            </div>
            <div class="control-group">
                <div class="info-row">
                    <span>G≈ÅO≈öNO≈öƒÜ KLIKU:</span>
                    <span id="volVal">50%</span>
                </div>
                <input type="range" id="volSlider" min="0" max="100" value="50">
            </div>
        </div>
        <div style="text-align:center">
            <button id="metroBtn">START</button>
            <div id="visual" class="flash-circle"></div>
        </div>
    </div>

    <div id="vocal-list"></div>
    <div id="instr-list"></div>
</div>

<script>
    const vocalVoices = [
        {id:'v_sop', name:'WOKAL SOPRAN'}, {id:'v_alt', name:'WOKAL ALT'},
        {id:'v_ten', name:'WOKAL TENOR'}, {id:'v_bas', name:'WOKAL BAS'}
    ];
    const instrVoices = [
        {id:'i_sop', name:'INSTR. SOPRAN'}, {id:'i_alt', name:'INSTR. ALT'},
        {id:'i_ten', name:'INSTR. TENOR'}, {id:'i_bas', name:'INSTR. BAS'}
    ];

    let audioCtx = null;
    let metroTimer = null;
    let recorders = {};
    let chunks = {};
    let audioFiles = {};

    async function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
    }

    document.body.addEventListener('touchstart', initAudio, { once: true });
    document.body.addEventListener('click', initAudio, { once: true });

    function render() {
        const vL = document.getElementById('vocal-list');
        const iL = document.getElementById('instr-list');
        vL.innerHTML = "<h3>üé§ G≈Çosy Wokalne</h3>";
        iL.innerHTML = "<h3>üéπ Instrumenty</h3>";
        vocalVoices.forEach(v => vL.innerHTML += createTrackHTML(v, 'vocal'));
        instrVoices.forEach(v => iL.innerHTML += createTrackHTML(v, 'instr'));
    }

    function createTrackHTML(v, type) {
        return `
            <div class="track ${type}">
                <div class="track-name">${v.name}</div>
                <div class="monitor-box">
                    <input type="checkbox" id="mon-${v.id}">
                    <label for="mon-${v.id}">S≈Çuchaj</label>
                </div>
                <div class="btns">
                    <button id="btn-${v.id}" class="rec" onclick="handleRec('${v.id}')">NAGRAJ</button>
                    <a id="dl-${v.id}" class="dl-btn">POBIERZ</a>
                </div>
            </div>`;
    }

    // Metronom
    const bpmS = document.getElementById('bpmSlider');
    const volS = document.getElementById('volSlider');
    bpmS.oninput = () => { document.getElementById('bpmVal').innerText = bpmS.value; if(metroTimer) { stopMetro(); startMetro(); } };
    volS.oninput = () => { document.getElementById('volVal').innerText = volS.value + "%"; };

    document.getElementById('metroBtn').onclick = async () => {
        await initAudio();
        if(metroTimer) { stopMetro(); document.getElementById('metroBtn').innerText="START"; }
        else { startMetro(); document.getElementById('metroBtn').innerText="STOP"; }
    };

    function startMetro() {
        const ms = 60000 / bpmS.value;
        metroTimer = setInterval(() => {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            osc.frequency.value = 1000;
            g.gain.setValueAtTime((volS.value/100)*0.4, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
            osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            const vis = document.getElementById('visual');
            vis.classList.add('active'); setTimeout(()=>vis.classList.remove('active'), 50);
        }, ms);
    }
    function stopMetro() { clearInterval(metroTimer); metroTimer = null; }

    // Nagrywanie
    async function handleRec(id) {
        await initAudio();
        const btn = document.getElementById(`btn-${id}`);
        if (recorders[id] && recorders[id].state === "recording") {
            recorders[id].stop();
            [...vocalVoices, ...instrVoices].forEach(v => { if(audioFiles[v.id]) audioFiles[v.id].pause(); });
            btn.classList.remove('active'); btn.innerText = "NAGRAJ";
            return;
        }
        [...vocalVoices, ...instrVoices].forEach(v => {
            if (document.getElementById(`mon-${v.id}`).checked && audioFiles[v.id]) {
                audioFiles[v.id].currentTime = 0; audioFiles[v.id].play();
            }
        });
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorders[id] = new MediaRecorder(stream);
            chunks[id] = [];
            recorders[id].ondataavailable = e => chunks[id].push(e.data);
            recorders[id].onstop = () => {
                const blob = new Blob(chunks[id], { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                audioFiles[id] = new Audio(url);
                const dl = document.getElementById(`dl-${id}`);
                dl.style.display = "flex"; dl.href = url; dl.download = `Studio_${id}.webm`;
            };
            recorders[id].start();
            btn.classList.add('active'); btn.innerText = "STOP";
        } catch(e) { alert("B≈ÇƒÖd mikrofonu!"); }
    }
    render();
</script>
</body>
</html>